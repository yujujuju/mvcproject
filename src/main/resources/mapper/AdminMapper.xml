<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.mvcproject.mapper.AdminMapper">

    <!-- 도서VO -->
    <resultMap id="bookMap" type="BookVO">
        <id property="bookId" column="BOOK_ID"/>
        <result property="title" column="TITLE"/>
        <result property="author" column="AUTHOR"/>
        <result property="publisher" column="PUBLISHER"/>
        <result property="pubDate" column="PUB_DATE"/>
        <result property="description" column="DESCRIPTION"/>
        <result property="imagePath" column="IMAGE_PATH"/>
    </resultMap>

    <!-- 도서요청VO -->
    <resultMap id="bookRequestMap" type="BookRequestVO">
        <id property="requestId" column="REQUEST_ID"/>
        <result property="title" column="TITLE"/>
        <result property="author" column="AUTHOR"/>
        <result property="publisher" column="PUBLISHER"/>
        <result property="userId" column="USER_ID"/>
        <result property="requestDate" column="REQUEST_DATE"/>
        <result property="status" column="STATUS"/>
        <result property="rejectReason" column="REJECT_REASON"/>
    </resultMap>

    <!-- 관리자용 도서 요청 전체 목록 조회 -->
    <select id="selectAllBookRequests" resultType="BookRequestVO" resultMap="bookRequestMap">
        SELECT *
            FROM (
                SELECT ROWNUM AS rn, r.*
                    FROM (
                        SELECT
                        REQUEST_ID,
                        TITLE,
                        AUTHOR,
                        PUBLISHER,
                        USER_ID,
                        REQUEST_DATE,
                        STATUS,
                        REJECT_REASON
                        FROM BOOK_REQUEST
                        ORDER BY REQUEST_DATE DESC
                        ) r
                    WHERE  <![CDATA[ ROWNUM <= #{endRow} ]]>
                     )
        WHERE <![CDATA[ rn >= #{startRow} ]]>
    </select>

    <!-- 전체 도서 요청 수 조회 -->
    <select id="getBookRequestCount" resultType="int">
        SELECT COUNT(*) FROM BOOK_REQUEST
    </select>

    <!-- 요청 도서 상세 -->
    <select id="selectBookRequestById" parameterType="int" resultMap="bookRequestMap">
        SELECT *
        FROM BOOK_REQUEST
        WHERE REQUEST_ID = #{requestId}
    </select>

    <!-- 요청 도서 승인 -->
    <update id="approveBookRequest" parameterType="int">
        UPDATE BOOK_REQUEST
        SET STATUS = '승인'
        WHERE REQUEST_ID = #{requestId}
    </update>


</mapper>

